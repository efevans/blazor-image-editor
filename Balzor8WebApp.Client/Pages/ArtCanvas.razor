@page "/canvas"
@using System.Runtime.InteropServices.JavaScript
@using MudBlazor.Utilities
@rendermode InteractiveWebAssembly

<MudFileUpload id="@FileInputId" Disabled="!AssemblyIsLoaded" T="IBrowserFile" FilesChanged="HandleFileUploaded" Accept="image/*" MaximumFileCount="1">
    <ButtonTemplate>
        <MudFab HtmlTag="label"
                Color="Color.Primary"
                StartIcon="@Icons.Material.Filled.Image"
                Label="Upload Image"
                for="@FileInputId" />
    </ButtonTemplate>
</MudFileUpload>
@if (!AssemblyIsLoaded)
{
    <div class="d-flex flex-row justify-center" style="min-height: 25rem;">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </div>
}
else if (ImageIsUploaded)
{
    <div class="d-flex flex-row gap-2 my-2">
        <MudButton Color="Color.Secondary" Variant="Variant.Filled" OnClick="HandleReset">Reset</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="HandleSave">Save</MudButton>
    </div>
    <div class="d-flex flex-row gap-2 my-2">
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="HandleDither">Dither</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="HandleInvert">Invert</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="HandleHalfInvert">Half Darken</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="HandleGammaCorrection">Gamma Correction</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="HandlePixelate">Pixelate</MudButton>
    </div>
    <canvas id="@CleanCanvasId" style="display: none;"></canvas>
    <MudStack Row="true" Style="margin-right: -20rem;" Class="flex-grow-1">
        <canvas id="@MainCanvasId" class="flex-grow-0" style="border: 1px solid black;"></canvas>
        <MudSpacer />
        <MudDropContainer @ref="EffectsUIListRef" T="EffectItem" Items="Effects" ItemsSelector="@((item,dropzone) => true)" ItemDropped="ItemUpdated" Class="d-flex flex-wrap flex-grow-0 align-start" Style="width: 30rem;">
            <ChildContent>
                <MudPaper Class="ml-4 flex-grow-1">
                    <MudList Clickable="true" Class="d-flex flex-column">
                        <MudListSubheader>Effects</MudListSubheader>
                        <MudDropZone T="EffectItem" Identifier="1" Class="flex-grow-1" AllowReorder="true" />
                    </MudList>
                </MudPaper>
            </ChildContent>
            <ItemRenderer>
                <MudListItem Text="@($"{context.Effect.ToString()} ({context.Order})")" />
            </ItemRenderer>
        </MudDropContainer>
    </MudStack>
}

@code {
    private const string ClassName = "ArtCanvas";
    private const string MainCanvasId = "tutorial";
    private const string CleanCanvasId = "clean-canvas";
    private const string FileInputId = "mud-file-uploader";

    private bool AssemblyIsLoaded = false;
    private bool ImageIsUploaded = false;

    private MudDropContainer<EffectItem> EffectsUIListRef { get; set; } = null!;

    private void ItemUpdated(MudItemDropInfo<EffectItem> dropItem)
    {
        Effects.UpdateOrder(dropItem, item => item.Order);
        Effects.Sort((e1, e2) => e1.Order > e2.Order ? 1 : -1);
        ResetImage(MainCanvasId, CleanCanvasId);
        ApplyEffects();
        Log(String.Join(", ", Effects.Select(e => e.Effect.ToString() + ": " + e.Order)));
    }

    private List<EffectItem> Effects = new();

    private class EffectItem
    {
        public Effect Effect { get; init; }
        public int Order { get; set; }
    }

    private enum Effect
    {
        Dither,
        Invert,
        HalfInvert,
        GammaCorrect,
        Pixelate
    }

    private readonly Dictionary<Effect, Action<string>> EffectOperations = new()
    {
        { Effect.Dither, ArtCanvas.ApplyDither },
        { Effect.Invert, ArtCanvas.ApplyInvert },
        { Effect.HalfInvert, ArtCanvas.ApplyHalfInvert },
        { Effect.GammaCorrect, ArtCanvas.ApplyGammaCorrection },
        { Effect.Pixelate, ArtCanvas.ApplyPixelate },
    };

    protected override async Task OnInitializedAsync()
    {
        if (OperatingSystem.IsBrowser())
        {
            await JSHost.ImportAsync(ClassName,
                $"../Pages/{ClassName}.razor.js");

            Log("I'm logging from interop!");
            AssemblyIsLoaded = true;
        }
    }

    private void HandleFileUploaded(IBrowserFile _)
    {
        if (OperatingSystem.IsBrowser())
        {
            Log("File Uploaded");
            ImageIsUploaded = true;
            UploadImage(FileInputId, MainCanvasId, CleanCanvasId);
        }
    }

    private void HandleSave()
    {
        if (OperatingSystem.IsBrowser())
        {
            Log("Save File");
            SaveImage(MainCanvasId);
        }
    }

    private void HandleReset()
    {
        if (OperatingSystem.IsBrowser())
        {
            Log("File Reset");
            Effects.Clear();
            ResetImage(MainCanvasId, CleanCanvasId);
            EffectsUIListRef.Refresh();
        }
    }

    private void ApplyEffect(Effect effect)
    {
        EffectOperations[effect](MainCanvasId);
    }

    private void ApplyEffects()
    {
        foreach (var effect in Effects)
        {
            ApplyEffect(effect.Effect);
        }
    }

    private void AddEffect(Effect effect, bool apply = true)
    {
        Effects.Add(new EffectItem { Effect = effect, Order = Effects.Count });
        EffectsUIListRef.Refresh();

        if (apply)
        {
            ApplyEffect(effect);
        }
    }

    private void HandleDither()
    {
        if (OperatingSystem.IsBrowser())
        {
            Log("ApplyDither");
            AddEffect(Effect.Dither);
        }
    }

    private void HandleInvert()
    {
        if (OperatingSystem.IsBrowser())
        {
            Log("ApplyInvert");
            AddEffect(Effect.Invert);
        }
    }

    private void HandleHalfInvert()
    {
        if (OperatingSystem.IsBrowser())
        {
            Log("ApplyHalfInvert");
            AddEffect(Effect.HalfInvert);
        }
    }

    private void HandleGammaCorrection()
    {
        if (OperatingSystem.IsBrowser())
        {
            Log("ApplyGammaCorrection");
            AddEffect(Effect.GammaCorrect);
        }
    }

    private void HandlePixelate()
    {
        if (OperatingSystem.IsBrowser())
        {
            Log("ApplyPixelate");
            AddEffect(Effect.Pixelate);
        }
    }
}